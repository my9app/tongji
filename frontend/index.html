<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteStats - ç»Ÿè®¡ä»ªè¡¨ç›˜</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#6366f1;--primary-dark:#4f46e5;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--bg:#f1f5f9;--sidebar:#1e293b;--card:#fff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
        
        /* ä¾§è¾¹æ  */
        .sidebar{width:280px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column;position:fixed;height:100vh;overflow:hidden}
        .sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,0.1)}
        .logo{font-size:24px;font-weight:700;display:flex;align-items:center;gap:10px}
        .logo span{opacity:0.7;font-size:14px;font-weight:400}
        
        .overview-stats{padding:20px;border-bottom:1px solid rgba(255,255,255,0.1)}
        .overview-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .overview-item{background:rgba(255,255,255,0.1);padding:12px;border-radius:8px;text-align:center}
        .overview-value{font-size:20px;font-weight:700}
        .overview-label{font-size:11px;opacity:0.7;margin-top:4px}
        
        .site-list{flex:1;overflow-y:auto;padding:10px}
        .site-group{margin-bottom:15px}
        .group-title{font-size:11px;text-transform:uppercase;opacity:0.5;padding:10px 10px 5px;letter-spacing:1px}
        .site-item{padding:12px 15px;border-radius:8px;cursor:pointer;transition:background 0.2s;display:flex;justify-content:space-between;align-items:center}
        .site-item:hover{background:rgba(255,255,255,0.1)}
        .site-item.active{background:var(--primary)}
        .site-name{font-weight:500;margin-bottom:2px}
        .site-domain{font-size:12px;opacity:0.6}
        .site-stats{text-align:right}
        .site-pv{font-size:14px;font-weight:600}
        .site-uv{font-size:11px;opacity:0.6}
        
        .sidebar-footer{padding:15px;border-top:1px solid rgba(255,255,255,0.1)}
        .btn-add{width:100%;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;font-weight:500;transition:background 0.2s}
        .btn-add:hover{background:var(--primary-dark)}
        .user-info{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1)}
        .user-name{font-size:13px;opacity:0.7}
        .btn-logout{background:none;border:none;color:#fff;opacity:0.7;cursor:pointer;font-size:12px}
        .btn-logout:hover{opacity:1}
        
        /* ä¸»å†…å®¹åŒº */
        .main{flex:1;margin-left:280px;padding:30px}
        
        /* é¡¶éƒ¨æ  */
        .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
        .page-title{font-size:24px;font-weight:600}
        .period-buttons{display:flex;gap:5px}
        .period-buttons button{padding:8px 16px;background:#fff;color:var(--text);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;transition:all 0.2s}
        .period-buttons button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:30px}
        .stat-card{background:var(--card);border-radius:12px;padding:25px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:15px}
        .stat-icon.blue{background:#eff6ff;color:#3b82f6}
        .stat-icon.green{background:#ecfdf5;color:#10b981}
        .stat-icon.orange{background:#fff7ed;color:#f97316}
        .stat-icon.purple{background:#f5f3ff;color:#8b5cf6}
        .stat-label{font-size:14px;color:var(--text-light);margin-bottom:8px}
        .stat-value{font-size:32px;font-weight:700}
        
        /* å›¾è¡¨åŒºåŸŸ */
        .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px}
        .chart-full{grid-column:1/-1}
        .card{background:var(--card);border-radius:12px;padding:25px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .card-title{font-size:16px;font-weight:600}
        .chart-container{position:relative;height:300px}
        
        /* è¡¨æ ¼ */
        .data-table{width:100%;border-collapse:collapse}
        .data-table th,.data-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
        .data-table th{font-weight:500;color:var(--text-light);font-size:12px;text-transform:uppercase}
        .data-table tr:hover{background:var(--bg)}
        .progress-bar{width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
        .progress-fill{height:100%;background:var(--primary);border-radius:3px}
        
        /* å®æ—¶åˆ—è¡¨ */
        .realtime-list{max-height:350px;overflow-y:auto}
        .realtime-item{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);gap:12px}
        .realtime-item:last-child{border-bottom:none}
        .device-icon{width:36px;height:36px;background:var(--bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .realtime-info{flex:1;min-width:0}
        .realtime-path{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .realtime-meta{font-size:12px;color:var(--text-light)}
        
        /* æ¨¡æ€æ¡† */
        .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:#fff;padding:30px;border-radius:16px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
        .modal-title{font-size:20px;font-weight:600;margin-bottom:20px}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;font-weight:500}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px}
        .form-group input:focus,.form-group textarea:focus{outline:none;border-color:var(--primary)}
        .form-group textarea{resize:vertical;min-height:80px}
        .modal-actions{display:flex;gap:10px;justify-content:flex-end}
        .modal-actions button{padding:12px 24px;border-radius:8px;font-size:14px;cursor:pointer;font-weight:500}
        .btn-primary{background:var(--primary);color:#fff;border:none}
        .btn-secondary{background:#fff;color:var(--text);border:1px solid var(--border)}
        .btn-danger{background:var(--danger);color:#fff;border:none}
        
        /* ä»£ç æ¡† */
        .code-block{background:#1e293b;color:#e2e8f0;padding:15px;border-radius:8px;font-family:monospace;font-size:12px;overflow-x:auto;white-space:pre-wrap;word-break:break-all;margin:15px 0}
        
        /* ç©ºçŠ¶æ€ */
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-light)}
        .empty-state h3{margin-bottom:10px;color:var(--text)}
        
        /* å“åº”å¼ */
        @media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:900px){.charts-grid{grid-template-columns:1fr}.sidebar{width:240px}.main{margin-left:240px}}
        @media(max-width:768px){.sidebar{display:none}.main{margin-left:0}.stats-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">ğŸ“Š LiteStats</div>
        </div>
        
        <div class="overview-stats">
            <div class="overview-grid">
                <div class="overview-item">
                    <div class="overview-value" id="totalTodayPV">0</div>
                    <div class="overview-label">ä»Šæ—¥ PV</div>
                </div>
                <div class="overview-item">
                    <div class="overview-value" id="totalTodayUV">0</div>
                    <div class="overview-label">ä»Šæ—¥ UV</div>
                </div>
                <div class="overview-item">
                    <div class="overview-value" id="totalSites">0</div>
                    <div class="overview-label">ç«™ç‚¹æ•°</div>
                </div>
                <div class="overview-item">
                    <div class="overview-value" id="totalOnline">0</div>
                    <div class="overview-label">å½“å‰åœ¨çº¿</div>
                </div>
            </div>
        </div>
        
        <div class="site-list" id="siteList">
            <!-- ç«™ç‚¹åˆ—è¡¨ -->
        </div>
        
        <div class="sidebar-footer">
            <button class="btn-add" onclick="showAddSiteModal()">+ æ·»åŠ ç«™ç‚¹</button>
            <div class="user-info">
                <span class="user-name" id="userName">ç®¡ç†å‘˜</span>
                <button class="btn-logout" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </aside>
    
    <!-- ä¸»å†…å®¹ -->
    <main class="main">
        <div class="topbar">
            <h1 class="page-title" id="pageTitle">é€‰æ‹©ç«™ç‚¹</h1>
            <div class="period-buttons">
                <button data-period="24h">24å°æ—¶</button>
                <button data-period="7d" class="active">7å¤©</button>
                <button data-period="30d">30å¤©</button>
                <button data-period="90d">90å¤©</button>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">ğŸ‘ï¸</div>
                <div class="stat-label">é¡µé¢æµè§ˆé‡ (PV)</div>
                <div class="stat-value" id="totalPV">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">ğŸ‘¤</div>
                <div class="stat-label">ç‹¬ç«‹è®¿å®¢ (UV)</div>
                <div class="stat-value" id="totalUV">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">ğŸŸ¢</div>
                <div class="stat-label">å½“å‰åœ¨çº¿</div>
                <div class="stat-value" id="onlineCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple">ğŸ“„</div>
                <div class="stat-label">å¹³å‡é¡µé¢/è®¿å®¢</div>
                <div class="stat-value" id="avgPages">0</div>
            </div>
        </div>
        
        <!-- å›¾è¡¨ -->
        <div class="charts-grid">
            <div class="card chart-full">
                <div class="card-header">
                    <div class="card-title">ğŸ“ˆ è®¿é—®è¶‹åŠ¿</div>
                </div>
                <div class="chart-container"><canvas id="trendChart"></canvas></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ–¥ï¸ è®¾å¤‡åˆ†å¸ƒ</div>
                </div>
                <div class="chart-container"><canvas id="deviceChart"></canvas></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸŒ æµè§ˆå™¨åˆ†å¸ƒ</div>
                </div>
                <div class="chart-container"><canvas id="browserChart"></canvas></div>
            </div>
        </div>
        
        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ”¥ çƒ­é—¨é¡µé¢</div>
                </div>
                <table class="data-table" id="pagesTable">
                    <thead><tr><th>é¡µé¢è·¯å¾„</th><th>è®¿é—®é‡</th><th>å æ¯”</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ”— æµé‡æ¥æº</div>
                </div>
                <table class="data-table" id="sourcesTable">
                    <thead><tr><th>æ¥æº</th><th>è®¿é—®é‡</th><th>å æ¯”</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸŒ å›½å®¶åˆ†å¸ƒ</div>
                </div>
                <table class="data-table" id="countriesTable">
                    <thead><tr><th>å›½å®¶</th><th>è®¿é—®é‡</th><th>å æ¯”</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">âš¡ å®æ—¶è®¿é—®</div>
                </div>
                <div class="realtime-list" id="realtimeList">
                    <div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- æ·»åŠ ç«™ç‚¹æ¨¡æ€æ¡† -->
    <div class="modal" id="addSiteModal">
        <div class="modal-content">
            <div class="modal-title">æ·»åŠ æ–°ç«™ç‚¹</div>
            <div class="form-group">
                <label>ç«™ç‚¹åç§° *</label>
                <input type="text" id="siteName" placeholder="æˆ‘çš„ç½‘ç«™">
            </div>
            <div class="form-group">
                <label>åŸŸå *</label>
                <input type="text" id="siteDomain" placeholder="example.com">
            </div>
            <div class="form-group">
                <label>åˆ†ç»„</label>
                <input type="text" id="siteGroup" placeholder="å¦‚ï¼šç”Ÿäº§ç¯å¢ƒã€æµ‹è¯•ç«™ç‚¹">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea id="siteNotes" placeholder="ç«™ç‚¹è¯´æ˜..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="hideModal('addSiteModal')">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="addSite()">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- ç«™ç‚¹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="siteDetailModal">
        <div class="modal-content">
            <div class="modal-title">ç«™ç‚¹è®¾ç½®</div>
            <div class="form-group">
                <label>ç«™ç‚¹åç§°</label>
                <input type="text" id="editSiteName">
            </div>
            <div class="form-group">
                <label>åˆ†ç»„</label>
                <input type="text" id="editSiteGroup">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea id="editSiteNotes"></textarea>
            </div>
            <div class="form-group">
                <label>è¿½è¸ªä»£ç </label>
                <div class="code-block" id="siteTrackingCode"></div>
                <button class="btn-secondary" style="margin-top:10px;width:100%" onclick="copyCode()">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="modal-actions">
                <button class="btn-danger" onclick="deleteSite()">åˆ é™¤ç«™ç‚¹</button>
                <button class="btn-secondary" onclick="hideModal('siteDetailModal')">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="updateSite()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentSite = null;
        let currentPeriod = '7d';
        let sites = [];
        let trendChart = null, deviceChart = null, browserChart = null;
        const API = location.origin;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // æ£€æŸ¥ç™»å½•
            const auth = await fetch('/api/check-auth').then(r => r.json());
            if (!auth.authenticated) {
                window.location.href = '/login';
                return;
            }
            document.getElementById('userName').textContent = auth.username;
            
            // åŠ è½½æ•°æ®
            loadOverview();
            loadSites();
            setupPeriodButtons();
            setInterval(loadRealtime, 30000);
            setInterval(loadOverview, 60000);
        });
        
        function setupPeriodButtons() {
            document.querySelectorAll('.period-buttons button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-buttons button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.dataset.period;
                    if (currentSite) loadStats();
                });
            });
        }
        
        async function loadOverview() {
            const data = await fetch('/api/overview').then(r => r.json());
            document.getElementById('totalTodayPV').textContent = data.today_pv.toLocaleString();
            document.getElementById('totalTodayUV').textContent = data.today_uv.toLocaleString();
            document.getElementById('totalSites').textContent = data.site_count;
            document.getElementById('totalOnline').textContent = data.online;
        }
        
        async function loadSites() {
            sites = await fetch('/api/sites').then(r => r.json());
            renderSiteList();
            if (sites.length > 0 && !currentSite) {
                selectSite(sites[0]);
            }
        }
        
        function renderSiteList() {
            const container = document.getElementById('siteList');
            
            // æŒ‰åˆ†ç»„æ•´ç†
            const groups = {};
            sites.forEach(site => {
                const group = site.group_name || 'æœªåˆ†ç»„';
                if (!groups[group]) groups[group] = [];
                groups[group].push(site);
            });
            
            let html = '';
            for (const [groupName, groupSites] of Object.entries(groups)) {
                html += `<div class="site-group">`;
                html += `<div class="group-title">${groupName}</div>`;
                groupSites.forEach(site => {
                    const isActive = currentSite && currentSite.id === site.id;
                    html += `
                        <div class="site-item ${isActive ? 'active' : ''}" onclick="selectSite(${JSON.stringify(site).replace(/"/g, '&quot;')})">
                            <div>
                                <div class="site-name">${site.name}</div>
                                <div class="site-domain">${site.domain}</div>
                            </div>
                            <div class="site-stats">
                                <div class="site-pv">${site.today_pv || 0}</div>
                                <div class="site-uv">${site.today_uv || 0} UV</div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            container.innerHTML = html || '<div class="empty-state"><p>æš‚æ— ç«™ç‚¹</p></div>';
        }
        
        function selectSite(site) {
            currentSite = site;
            document.getElementById('pageTitle').textContent = site.name;
            renderSiteList();
            loadStats();
        }
        
        async function loadStats() {
            if (!currentSite) return;
            
            const data = await fetch(`/api/stats/${currentSite.id}?period=${currentPeriod}`).then(r => r.json());
            
            document.getElementById('totalPV').textContent = data.summary.pv.toLocaleString();
            document.getElementById('totalUV').textContent = data.summary.uv.toLocaleString();
            document.getElementById('avgPages').textContent = data.summary.uv > 0 ? (data.summary.pv / data.summary.uv).toFixed(1) : '0';
            
            updateTrendChart(data.daily);
            updateDeviceChart(data.devices);
            updateBrowserChart(data.browsers);
            updateTable('pagesTable', data.pages, 'path', 'views', data.summary.pv);
            updateTable('sourcesTable', data.sources, 'source', 'count', data.summary.pv);
            updateTable('countriesTable', data.countries, 'country', 'count', data.summary.pv);
            
            loadRealtime();
        }
        
        async function loadRealtime() {
            if (!currentSite) return;
            const data = await fetch(`/api/realtime/${currentSite.id}`).then(r => r.json());
            document.getElementById('onlineCount').textContent = data.online;
            
            const list = document.getElementById('realtimeList');
            if (data.recent.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
                return;
            }
            list.innerHTML = data.recent.map(item => `
                <div class="realtime-item">
                    <div class="device-icon">${item.device === 'Mobile' ? 'ğŸ“±' : 'ğŸ’»'}</div>
                    <div class="realtime-info">
                        <div class="realtime-path">${item.path}</div>
                        <div class="realtime-meta">${item.country || 'æœªçŸ¥'} Â· ${item.timestamp}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {label: 'PV', data: data.map(d => d.pv), borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.4},
                        {label: 'UV', data: data.map(d => d.uv), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.4}
                    ]
                },
                options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero: true}}}
            });
        }
        
        function updateDeviceChart(data) {
            const ctx = document.getElementById('deviceChart').getContext('2d');
            if (deviceChart) deviceChart.destroy();
            deviceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {labels: data.map(d => d.device), datasets: [{data: data.map(d => d.count), backgroundColor: ['#6366f1', '#10b981', '#f59e0b']}]},
                options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {position: 'bottom'}}}
            });
        }
        
        function updateBrowserChart(data) {
            const ctx = document.getElementById('browserChart').getContext('2d');
            if (browserChart) browserChart.destroy();
            browserChart = new Chart(ctx, {
                type: 'doughnut',
                data: {labels: data.map(d => d.browser), datasets: [{data: data.map(d => d.count), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899']}]},
                options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {position: 'bottom'}}}
            });
        }
        
        function updateTable(tableId, data, labelKey, valueKey, total) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(item => {
                const percent = total > 0 ? (item[valueKey] / total * 100).toFixed(1) : 0;
                return `<tr><td>${item[labelKey] || 'ç›´æ¥è®¿é—®'}</td><td>${item[valueKey]}</td><td><div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div></td></tr>`;
            }).join('');
        }
        
        // æ¨¡æ€æ¡†
        function showAddSiteModal() {
            document.getElementById('addSiteModal').classList.add('active');
        }
        
        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        async function addSite() {
            const name = document.getElementById('siteName').value.trim();
            const domain = document.getElementById('siteDomain').value.trim();
            const group_name = document.getElementById('siteGroup').value.trim();
            const notes = document.getElementById('siteNotes').value.trim();
            
            if (!name || !domain) {
                alert('è¯·å¡«å†™ç«™ç‚¹åç§°å’ŒåŸŸå');
                return;
            }
            
            const resp = await fetch('/api/sites', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, domain, group_name, notes})
            });
            
            if (resp.ok) {
                hideModal('addSiteModal');
                document.getElementById('siteName').value = '';
                document.getElementById('siteDomain').value = '';
                document.getElementById('siteGroup').value = '';
                document.getElementById('siteNotes').value = '';
                loadSites();
                loadOverview();
            } else {
                const err = await resp.json();
                alert(err.detail || 'æ·»åŠ å¤±è´¥');
            }
        }
        
        function showSiteDetail() {
            if (!currentSite) return;
            document.getElementById('editSiteName').value = currentSite.name;
            document.getElementById('editSiteGroup').value = currentSite.group_name || '';
            document.getElementById('editSiteNotes').value = currentSite.notes || '';
            
            const code = `<script>
window.LITESTATS_URL = '${API}';
window.LITESTATS_TOKEN = '${currentSite.token}';
<\/script>
<script src="${API}/tracker.js"><\/script>`;
            document.getElementById('siteTrackingCode').textContent = code;
            
            document.getElementById('siteDetailModal').classList.add('active');
        }
        
        async function updateSite() {
            if (!currentSite) return;
            
            await fetch(`/api/sites/${currentSite.id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: document.getElementById('editSiteName').value.trim(),
                    group_name: document.getElementById('editSiteGroup').value.trim(),
                    notes: document.getElementById('editSiteNotes').value.trim()
                })
            });
            
            hideModal('siteDetailModal');
            loadSites();
        }
        
        async function deleteSite() {
            if (!currentSite) return;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç«™ç‚¹ "${currentSite.name}" å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ¸…é™¤ï¼`)) return;
            
            await fetch(`/api/sites/${currentSite.id}`, {method: 'DELETE'});
            currentSite = null;
            hideModal('siteDetailModal');
            loadSites();
            loadOverview();
        }
        
        function copyCode() {
            const code = document.getElementById('siteTrackingCode').textContent;
            navigator.clipboard.writeText(code).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
        }
        
        async function logout() {
            await fetch('/api/logout', {method: 'POST'});
            window.location.href = '/login';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) this.classList.remove('active');
            });
        });
        
        // åŒå‡»ç«™ç‚¹æ‰“å¼€è®¾ç½®
        document.getElementById('siteList').addEventListener('dblclick', function(e) {
            const item = e.target.closest('.site-item');
            if (item && currentSite) showSiteDetail();
        });
    </script>
</body>
</html>
